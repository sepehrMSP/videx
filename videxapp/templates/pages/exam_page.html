{% extends 'bare_base.html' %}

{% block title %}
    {{ exam.name }}
{% endblock %}

{% block content %}
<div class="ui breadcrumb">
    <a class="section" href="{% url 'home' %}">home</a>
    <i class="fa fa-angle-right" style="margin: 5px;" aria-hidden="true"></i>
    <a class="section" href="{% url 'courses' %}">courses</a>
    <i class="fa fa-angle-right" style="margin: 5px;" aria-hidden="true"></i>
    <a class="section" href="../">{{ exam.course.name }}</a>
    <i class="fa fa-angle-right" style="margin: 5px;" aria-hidden="true"></i>
    <div class="active section">{{ exam.name }}</div>
</div>
<div class="row">
<div class="col-md-9">
    <h1>{{ exam.name }}</h1>
    <h2>Questions</h2>
    {% if rule == "instructor" %}
    <ol>
    {% for question in questions %}
        <li>
            {{ question.text }}
            {% if question.type == "multi_choice" %}
            <br>
            <ul>
                {% for choice in question.choices %}
                    <li>{{ choice }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </li>
    {% endfor %}
    </ol>
    <a href="./{{exam.id}}/question/add " class="btn btn-primary">Add question</a>
    {% elif time_state == "before_release" %}
    <p>You don't have access before start</p>
    {% elif time_state == "before_deadline" %}
    {% for question in questions %}
        <li>
            {{ question.text }}
            <br>
            {% if question.type == "multi_choice" %}
            <ul>
                {% for choice in question.choices %}
                    <li>
                        <input type="radio"
                            id="ans{{ question.id }}_{{ forloop.counter }}"
                            name="ans{{ question.id }}" value="{{ forloop.counter }}">
                        {{ choice }}
                    </li>
                {% endfor %}
            </ul>
            {% else %}
            <textarea id="ans{{ question.id }}" style="width: 100%;">{{ question.answer }}</textarea>
            {% endif %}
        </li>
    {% endfor %}
    <button id="submit" class="btn btn-primary">Submit answers</button>
    {% csrf_token %}
    <script>
        const setAnswer = (id, ty, answer) => {
            if (ty === 'multi_choice') {
                document.getElementById(`ans${id}_${answer}`).checked = true;
            }
        };
        // {% for question in questions %}
        setAnswer("{{ question.id }}", "{{ question.type }}", "{{ question.answer }}"),
        // {% endfor %}
        document.getElementById('submit').onclick = submitAnswers = async () => {
            const calcAnswer = (id, ty) => {
                if (ty === 'multi_choice') {
                    for (let i = 1; i < 5; i += 1) {
                        if (document.getElementById(`ans${id}_${i}`).checked) {
                            return `${i}`;
                        }
                    }
                    return "";
                } else {
                    return document.getElementById(`ans${id}`).value;
                }
            };
            const csrf_token = document.getElementsByName('csrfmiddlewaretoken')[0].value;
            const result = JSON.stringify({
                // {% for question in questions %}
                    "{{ question.id }}": calcAnswer("{{ question.id }}", "{{ question.type }}"),
                // {% endfor %}
            });
            await fetch("./{{ exam.id }}/submit", {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrf_token,
                },
                body: result,
            });
        };
    </script>
    {% else %}
    {% for question in questions %}
        <li>
            {{ question.text }}
            <br>
            {% if question.type == "multi_choice" %}
            <ul>
                {% for choice in question.choices %}
                    <li>{{ choice }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <textarea disabled="true" style="width: 100%;">{{ question.answer }}</textarea>
            {% endif %}
        </li>
    {% endfor %}
    {% endif %}

</div>
<div class="col-md-3">
    {% if time_state == "before_release" %}
    <h3>Not released yet</h3>
    <p>Time to release: {{ exam.release_date|timeuntil }}</p>
    {% elif time_state == "before_deadline" %}
    <h3>Currently active</h3>
    <p>Time to deadline: {{ exam.deadline_date|timeuntil }}</p>
    {% else %}
    <h3>Time is over</h3>
    <p>Time past from deadline: {{ exam.deadline_date|timesince }}</p>
    {% endif %}
    {% if rule == "instructor" %}
    <a href="./{{exam.id}}/edit" class="btn btn-primary">Edit</a>
    {% endif %}
</div>
</div>
{% endblock %}
